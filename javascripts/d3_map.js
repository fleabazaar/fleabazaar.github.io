function zoom(t){g.transition().duration(750).attr("transform","translate("+projection.translate()+")scale("+t[2]+")translate(-"+t[0]+",-"+t[1]+")").selectAll(["#countries","#states","#cities"]).style("stroke-width",1/t[2]+"px").selectAll(".city").attr("d",path.pointRadius(20/t[2]))}function get_xyz(t){var e=path.bounds(t),a=(e[1][0]-e[0][0])/width,i=(e[1][1]-e[0][1])/height,o=.96/Math.max(a,i),n=(e[1][0]+e[0][0])/2,s=(e[1][1]+e[0][1])/2+height/o/6;return[n,s,o]}function country_clicked(t){if(g.selectAll(["#states","#cities"]).remove(),state=null,country&&g.selectAll("#"+country.id).style("display",null),t&&country!==t){var e=get_xyz(t);country=t,"USA"==t.id||"JPN"==t.id?d3.json("/json/states_"+t.id.toLowerCase()+".topo.json",function(a,i){g.append("g").attr("id","states").selectAll("path").data(topojson.feature(i,i.objects.states).features).enter().append("path").attr("id",function(t){return t.id}).attr("class","active").attr("d",path).on("click",state_clicked),zoom(e),g.selectAll("#"+t.id).style("display","none")}):zoom(e)}else{var e=[width/2,height/1.5,1];country=null,zoom(e)}}function state_clicked(t){if(g.selectAll("#cities").remove(),t&&state!==t){var e=get_xyz(t);state=t,country_code=state.id.substring(0,3).toLowerCase(),state_name=state.properties.name,d3.json("/json/cities_"+country_code+".topo.json",function(t,a){g.append("g").attr("id","cities").selectAll("path").data(topojson.feature(a,a.objects.cities).features.filter(function(t){return state_name==t.properties.state})).enter().append("path").attr("id",function(t){return t.properties.name}).attr("class","city").attr("d",path.pointRadius(20/e[2])),zoom(e)})}else state=null,country_clicked(country)}var m_width=$("#map").width(),width=938,height=500,country,state,projection=d3.geo.mercator().scale(150).translate([width/2,height/1.5]),path=d3.geo.path().projection(projection),svg=d3.select("#map").append("svg").attr("preserveAspectRatio","xMidYMid").attr("viewBox","0 0 "+width+" "+height).attr("width",m_width).attr("height",m_width*height/width);svg.append("rect").attr("class","background").attr("width",width).attr("height",height).on("click",country_clicked);var g=svg.append("g");d3.json("/json/countries.topo.json",function(t,e){g.append("g").attr("id","countries").selectAll("path").data(topojson.feature(e,e.objects.countries).features).enter().append("path").attr("id",function(t){return t.id}).attr("d",path).on("click",country_clicked)}),$(window).resize(function(){var t=$("#map").width();svg.attr("width",t),svg.attr("height",t*height/width)});